# 计算机网络基本概念



## 概念

计算机网络是一种互连的、自治的计算机集合：

- 互连指互联互通，即通信链路。
- 自治是指计算机系统之间无主从关系，不能彼此控制对方。
- 经历了单个网络、三级结构互联网、多层次ISP互联网的阶段。

## 功能

1. 数据通信，传输数据
2. 资源共享
   - 硬件资源共享，如打印机共享
   - 软件资源共享，部分软件无需下载即可共享使用
   - 数据资源共享，观看视频
3. 分布式处理，多台计算机承担工作的不同部分
4. 提高可靠性，计算机宕机后可由其他计算机接手工作
5. 负载均衡，多态计算机分配统一工作

## 组成

1. 组成部分
   - 硬件：包括端系统即主机、链路、路由器
   - 软件：应用软件
   - 协议：一系列规则约定的集合
2. 边缘部分：即主机所存在的部分
   - C/S方式：即客户端/服务器模式
   - P2P方式：对等身份
3. 核心部分：包含部分服务器和大部分网络
   - 通信子网：用来实现数据通信
   - 资源子网：用来实现资源共享/数据处理

## 分类

1.按分布范围分：

- 广域网WAN：跨度非常广，通常要跨国。常用于交换技术。
- 城域网MAN：一个城市内的跨度
- 局域网LAN：方圆一千里左右。常用于广播技术。
- 个人区域网PAN：方圆十米以内，例如蓝牙耳机。

2.按使用者分：

- 公用网：三大运营商网络
- 专用网：军队医院等专用的网络。

3.按照交换技术分：电路交换、报文交换、分组交换。

4.按照拓扑结构分：总线型、星型、环型、网状型

5.按传输技术分：

- 广播式网络：共享公共通信信道
- 点对点式网络：使用分组存储转发和路由选择机制

## 性能指标

速率：bit、byte、KB、MB、GB、TB等

带宽：原指频带宽度，即最高频率与最低频率之差，单位是赫兹Hz，网络中常指速率，即bit/s

吞吐量：单位时间内通过某个网络（或信道，或接口）的数据量

发送时延：数据长度(bit) / 发送速率(bit/s)

传播时延：传输路径长度 / 传播速率(bit/s)

排队时延：数据包在网络设备中等待被处理的时间

处理时延：数据包到达设备或者目的机器被处理所需要的时间

**总时延 = 发送时延 + 传播时延 + 排队时延 + 处理时延**

RTT：数据报文在端到端通信中来回一次的时间

信道利用率：有数据通过的时间 / 没有数据通过的时间 * 100%

## 分层结构模型

互联网标准由国际标准化组织（ISO）制定，因特网标准一定是RFC，但是RFC不一定是因特网标准。因RFC需经过4个阶段才能成为因特网标准。

层次结构设计的基本原则：**各层之间是相互独立的、每一层具有足够的灵活性、各层之间完全解耦**。

**分层好处：**

- 各层之间相互独立、灵活性好、结构上易于分割、易于实现和维护
- 能促进标准化工作

**网络协议的组成要素**

- 语法:数据与控制信息的结构或格式 。 
- 语义:需要发出何种控制信息，完成何种动作以及做出何种响应。 
- 同步:事件实现顺序的详细说明。

![](https://isbut-blog.oss-cn-shenzhen.aliyuncs.com/markdown-img/ouQIUg.jpg)

**OSI七层模型**

- 应用层：与用户交互产生网络流量的程序，如QQ等

  - 主要协议：FTP、SMTP、HTTP

- 表示层：处理通信中信息的表示方式，

  - 功能：数据格式转换、数据加密解密、数据压缩和恢复

- 会话层：向用户进程提供建立连接并传输数据，如观看网页视频。

  - 功能：建立、管理、终止会话，从失效点恢复通信，实现数据同步

- 传输层：负责端到端通信，传输单位是报文段或用户数据包；

  - 功能：可靠传输、不可靠传输、差错控制、流量控制、复用分用

  - 主要协议：TCP、UDP、RUDP等

- 网络层：把分组从源端传送到目的端，为分组在交换网上的不同主机提供通信服务，当数据报过长会切割。

  - 功能：路由选择、流量控制、差错控制、拥塞控制

  - 主要协议：IP、ICMP、ARP、RARP、OSPF

- 数据链路层：将网络层传下来的数据报组装成帧，数据链路层的传输单位是帧。

  - 功能：成帧（定义帧的开始和结束）、差错控制、流量控制、访问控制
  - 主要协议：PPP、STP、SDLC

- 物理层：在物理媒体上实现比特流的透明传输，物理层传输单位是比特。

  - 功能：定义接口特性、定义传输模式（单工、半双工、双工）、定义传输速率、比特同步、比特编码
  - 主要协议：802.3

  |          | OSI参考模型                                     | TCP/IP参考模型                                               |
  | -------- | ----------------------------------------------- | ------------------------------------------------------------ |
  | 基本概念 | OSI模型先于协议发明定义了三点：服务、协议、接口 | TCP/IP协议先于模型发明在设计之初就考虑到易购网互联问题，将IP作为重要层次 |
  | 网络层   | 无连接①+面向连接②                               | 无连接                                                       |
  | 传输层   | 面向连接                                        | 无连接+面向连接                                              |

## 传输单元名词

| 计算机网络系统层次 | 传输单元名词   | 具体内容                                                     |
| ------------------ | -------------- | ------------------------------------------------------------ |
| 应用层             | 报文           | 比如应用层发送的数据属于报文                                 |
| 传输层             | 报文段         | 若数据量小则不会分割，否则其报文就是单独的一个报文段。       |
| 网络层             | IP数据报、分组 | IP数据报就是给报文段封装上网络层的IP地址，包括目的地址、源地址。如果IP数据报还是太大了，就再切割，切割成分组。小的数据报就是单独的一个分组。 |
| 数据链路层         | 帧             | 在分组的基础上，头部加上mac物理地址，尾部再加一个fcs帧检验序列、帧开始及结束标识符等数据 |
| 物理层             | 比特流         | 01101001,01101;01101!10101101?010101010.                     |

# 物理层

**物理层主要设备是集线器、中继器**。

**物理层的作用是**

- 连接不同的物理设备（比如路由器到计算机通过网线进行连接）
- 传输比特流（比特流就是0、1这样的高低电平，或者说是数字信号）

**传输介质**：双绞线、同轴电缆、光纤

**比特流**：用高电平表示1、低电平表示0，形成比特流

## **信道的基本概念**

- 单工通信信道：只有一个方向通信
- 半双工通信信道：双方都可以发送和接收消息，但不能同时发送或者同时接收
- 全双工通信信道：双方都可以同时发送或者接收消息

**信道复用技术**

- 频分复用：按照频带复用
- 时分复用：按照时分复用
- 统计时分复用：不固定每个用户在时分复用帧的位置，只要有数据就集中起来组成统计时分复用帧发送
- 波分复用：按照光的频分复用
- **码分复用**：即CDMA，为每个用户分配 m bit 的码片，根据规则发送更改后的码片，再通过内积运算区分发送的数据，此时发送的数据量为原先的m倍

# 数据链路层

**数据链路层设备：交换机。**

数据链路层使用的信道主要有以下两种类型：

- **点对点信道**。这种信道使用一对一的点对点通信方式。
- **广播信道**。这种信道使用一对多的广播通信方式，因此过程比较复杂。广播信道上连接的主机很多，因此必须使用专用的共享信道协议来协调这些主机的数据发送

数据链路层主要是解决了以下三个问题

- 封装成帧
- 透明传输

- 差错检测

## **封装成帧**

帧是数据链路层数据的基本单位。通过在帧的首部及尾部添加控制信息来标识帧的开始及结束。

组帧方法：

1. 字符计数法，缺点：若字符失真，则数据混乱
2. 字符填充法，添加相应的开始结束字符，数据中若出现与开始或结束字符相同的，则变为转义字符
3. 零比特传输法，用二进制位标识开始和结束，数据中若出现与其相同的，则添加一位做差异化，接收端接受后去除添加的转义位
4. 违规编码法，违法的编码方式来表示起始结束

## **差错检测**

- 纠错编码：
  - 海明码
    - 确定校验码位数r、确定校验码和数据的位置、求出校验码的值、检错并纠错
- 检错编码：
  - 奇偶效验码
    - 奇偶校验码分为一位校验码和 n - 1 位信息元。其编码方式分为奇校验偶校验。奇校验是在数据前面加一位0或1，使1的个数为奇数。偶校验码就是加一位1的数量变偶数
  - 循环冗余码
    - 即CRC冗余码检测，将表达式的式子转为二进制数因子，数据按照最高阶尾数添加n个零，并添加用发送的数据除以因子得到余数，接收方用处理完的数据除以因子，若余数为0，则数据正确

## **点对点协议PPP**

互联网用户通常需要连接到某个 ISP 之后才能接入到互联网，PPP 协议是用户计算机和 ISP 进行通信时所使用的数据链路层协议。

## **以太网协议**

计算机中发送数据主要由：MAC地址、以太网协议决定。

- MAC协议：即硬件地址，共48位，由16进制表示，每台设备都有唯一的MAC地址，可由 ifconfig -a查询
- <img src="https://isbut-blog.oss-cn-shenzhen.aliyuncs.com/markdown-img/2021091115060790665.png" alt="2021091115060790665.png" style="zoom: 33%;" />
- 目的地址、源地址：MAC地址
- 类型：表明帧是哪个协议的数据
- 帧数据：具体发的数据
- FCS：循环冗余校验码

**MAC地址表**

关于MAC地址具体映射到硬件接口的表，进行相邻物理节点数据的传输。具有自学习的功能，传输过程中可以更新自己的MAC地址表。

## CSMA协议

全程载波监听多路访问协议，发送帧之前，先监听信道。

- 若信道空闲，则发送完整的帧；若信道忙，就推迟发送。而至于推迟多久，是否立即发送完整的帧，有三种不同的协议规则。

## CSMA/CD协议

全称载波监听多点接入/碰撞检测协议，先检测信道，再发送，同时发送的时候也在检测。

**MTU**

数据链路层的数据帧不是无限大的（因此MTU描述的就是最大可传输的数据帧）

# 网络层

**网络层主要设备是路由器。**

**概念**：

- 主要任务是把分组从源端传到目的端，为分组交换网上的不同主机提供通信服务
- 网络层的传输单位是数据报
- 数据报与分组的关系：数据报是比较长的，而分组就是相当于把数据报进行分割形成

**功能：**

- **找路与分组转发**：通过路由算法找到最佳路径，并把分组通过最佳路径转发

- **异构网互联**：不同的网络叫做异构网，网络层可以通过路由器把这些网络连接起来，构成一个更大的网络

- **拥塞控制**：若所有结点都来不及接受分组，而要丢弃大量分组的话，网络就处于拥塞状态。故需要采用相关方法进行拥塞控制

  ![202109111533349105.png](https://isbut-blog.oss-cn-shenzhen.aliyuncs.com/markdown-img/202109111533349105.png)

## 电路交换

**面向连接，事先得建立连接。**

- 具体：建立连接、通信、释放连接
- 优点：
  - 传输速度快、高效、实时
- 缺点：
  - 计算机数据具有突发性，会导致链路利用率低

## 报文交换

报文指源应用发送的信息整体。报文会被传输层分割成报文段，然后给报文加上ip地址、物理地址，并在物理层上进行数据传输。

- 优点：无需建立连接、存储转发，动态分配线路、可靠性高、利用率高、多目标服务
- 缺点：报文大小不定，需要网络节点有较大缓存空间

## 分组交换

**在发送端，分组分成小的、固定长度的数据段。**

- 具体：分割成分组、添加首部（含有地址等控制信息）构成分组、收到分组后剥去首部、还原成报文。
- 优点：

  - 高效: 动态分配传输带宽，对通信链路是逐段占用。
  - 灵活: 以分组为传送单位和查找路由。

  - 迅速: 不必先建立连接就能向其他主机发送分组。（针对于电路交换来说）
  - 可靠: 保证可靠性的网络协议；分布式的路由选择协议使网络有很好的生存性。
- 缺点：

  - 分组转发的时候需要排队，造成一定的时延
  - 分组必须携带首部，造成开销
- 数据报（无连接服务）与虚电路（有连接服务）是分组交换方式的子类。

### 数据报和虚电路交换

**两者均是分组交换的子类。**

数据报交换方式为网络层提供无连接服务。不事先为分组的传输确定传输路径，每个分组独立确定传输路径，不同分组传输路径可能不同。

虚电路交换方试为网络层提供连接服务。事先为分组的传输确定传输路径（建立连接），然后沿该路径（连接）传输系列分组，系列分组传输路径相同，传输结束后拆除连接。

- 本质上是将分组交换和电路交换进行了融合

## IP协议

IP协议使得网络层可以**屏蔽底层细节**而专注网络层的**数据转发**，解决了在虚拟网络中数据报传输路径的问题。

**IP数据报格式**

![](https://isbut-blog.oss-cn-shenzhen.aliyuncs.com/markdown-img/202109111533370118.png)

首部还可分为固定部分和可变部分。固定部分有20字节。

![202109111533373569.png](https://isbut-blog.oss-cn-shenzhen.aliyuncs.com/markdown-img/202109111533373569.png)

 1. 版本：IPv4或IPv6。
  2. 首部长度：只有四个字节，所以只能表示0~15。单位是4Byte，首部长度默认为20Byte，所以这个值肯定是5 —— 0101
  3. 区分服务：指示期望获得哪种类型的服务。只有在使用区分服务的时候，这个字段才有用，否则就没用。
  4. 总长度：表示首部 + 数据的数据长度，单位是1Byte，因为字段长度为16位，如果数据太长会进行切片（**大于MTU**-1500字节）。
  5.  标识、标志、片偏移：协议内部标识，即标记IP报文是否可以分片，以及分片的片偏移
  6. 生存时间（TTL）：IP分组的生命周期
  7. 协议：数据部分使用的协议。
     ![2021091115333815410.png](https://isbut-blog.oss-cn-shenzhen.aliyuncs.com/markdown-img/2021091115333815410.png)
  8. 首部检验和：只检验首部。如果路由器检验出错则丢弃数据。
  9. 可选字段：0~40Byte用来支持排错、测量以及安全等措施。
  10. 填充：全0，用来把首部补充成4Byte的整数。
  11. 源地址、目的地址：发送的源及目的地址IP。

**IP协议转发流程**

通过路由表和IP报文内的内容进行转发。

**路由表：**

路由表根据**路由选择算法**得出的，主要用途是路由选择，总用软件来实现。它包括：目的网络IP地址、子网掩码、下一跳IP地址、接口，以及默认路由（不知道往哪发的时候默认往哪发）

**转发表：**

转发表由**路由表**得来，可以用软件实现，也可以用特殊的硬件来实现。转发表必须包含完成转发功能所必需的信息，在转发表的每一行必须包含从要到达的目的网络到输出端口和某些MAC地址信息的映射。

**IP数据报三种传输方式**

- 单播：发送给单个目的地，属于点对点
- 多播：发送数据包到同一广播域或子网内的所有设备，属于点对多点
- 多播/组播：组播数据者借助组播路由协议为组播数据报建立组播分发树，由分发树复制分发给用户，属于点对多点

**组播**

IP组播地址：IP组播地址让源设备能够将分组发送给一组设备。属于多播组的设备将被分配**一个组播组IP地址**，范围为224.0.0.0~239.255.255.255，只能作为分组的**目标地址**，源地址总为**单播地址**。

- 组播数据报应用于UDP
- 对组播数据报不产生ICMP差错报文
- 并非所有D类地址都可作为组播地址

IGMP协议可以让路由器知道是否有主机退出了某个组播组。

- 加入组播组的时候，发送IGMP报文，声称成为该组成员
- 组播路由器收到后，利用组播路由选择协议转发这组成员关系给其他组播路由器
- 组播路由器周期性探询本机主机是否还是组播组的成员
- 若某个组的主机均无回应，则不再把这组的成员关系转发给其他路由器

## IPv4

IPv4地址长度为32位，常分成4个8位，常用点分十进制表示。

IP地址分为两个部分，分别是**网络号**和**主机号**。可以将IP地址分为以下几类：

![2021091115334113214.png](https://isbut-blog.oss-cn-shenzhen.aliyuncs.com/markdown-img/2021091115334113214.png)

- A类地址的网络号为8位，且首位是0
- B类地址的网络号为16位，并且前两位是10

- C地址的网络号为24位，并且前三位是110

**特殊IP地址**

![2021091115334241416.png](https://isbut-blog.oss-cn-shenzhen.aliyuncs.com/markdown-img/2021091115334241416.png)

**私有IP地址**

![](https://isbut-blog.oss-cn-shenzhen.aliyuncs.com/markdown-img/2021091115334388117.png)

## IPv6

为了扩容ip地址的数量，研发了IPv6地址。**用十六进制表示，类型有单播、多播、任播。**

表示方式：

- 一般形式：4BF5:0000:0000:0000:BA 5F:039A:000A:2176
- 压缩方式：4BF5:0:0:0:BA5F:39A:A:2176
- 零压缩方式（一连串的零用一对冒号表示）：4BF5::BA5F:39A:A:2176

![2021091115335618941](https://isbut-blog.oss-cn-shenzhen.aliyuncs.com/markdown-img/2021091115335618941.png)

1. 版本：指明了协议版本，即6（0110)
2. 优先级：区分数据报的类别和**优先级**
3. 流标签：“流”是互联网络上从特定源点到特定终点的一系列数据报。所有属于同一个流的数据报都具有同样的流标签。
4. 有效载荷长度：有效载荷的长度。注意要和IPv4区分开，IPv4是报文长度，而IPv6是除了头部长度外的报文长度。
5. 下一个首部：标识下一个扩展首部或上层协议首部。
6. 跳数限制：相当于是IPv4的TTL，如果跳数限制达到零则丢弃掉该数据报并返回ICMP差错报文。
7. 原地址和目的地址：需要注意，对于IPv4，这两个字段都是32位，而对于IPv6而言，是128位。

**IPv4 和 IPv6 的区别**

- IPv6将地址从32位扩大到128位，更大的地址空间
- IPv6相对于IPv4变更了一些字段
- IPv6支持即插即用，无需DHCP
- IPv6只能在**主机处分片**，IPv4可以在路由器和主机处分片。

**IPv4 和 IPv6的兼容方法：双协议栈、隧道协议（协议转换）**

## 子网划分

IP地址分类缺点：空间利用率低、两级IP地址不够灵活。

**子网划分**：

在子网划分的时候，会将IP分成三个部分，即网络号、子网号、主机号

- ![image-20211130234102558](https://isbut-blog.oss-cn-shenzhen.aliyuncs.com/markdown-img/image-20211130234102558.png)

以193.10.10.0为例子，取一位作为子网号，则分为两个网段

- ![image-20211130234157192](https://isbut-blog.oss-cn-shenzhen.aliyuncs.com/markdown-img/image-20211130234157192.png)

**子网掩码**

1. 子网掩码和IP地址一样，均为32位
2. 子网掩码由连续的0和连续的1组成
3. 某一个子网的子网掩码，具有网络号位数个连续的1
4. 其中子网号能不能全1/0要看情况，主机号绝对不能全1/0。

**通过子网掩码和IP进行与运算，就可以快速得到该IP所属的子网号**

## 无分类编制CIDR

CIDR无A、B、C类网络号和子网划分概念，将网络前缀相同的IP称为一个CIDR地址块，更好地划分子网。

对于CIDR的IP地址分为：**网络前缀、主机号，而网络前缀的位数可以是任意的**。

一般采用**斜线记法**，例如192.10.10.129/25，则前25位为网络号，后面7位为主机号。

**多个子网聚合成超网。**

## NAT地址转换技术

内网多个设备使用一个外网IP对外通信，此时使用到了**NAT技术。**IP地址分为两类：**内网地址、外网地址。**

**内网地址：内部机构使用，避免与外网地址重复**

- 10.0.0.0 ~ 10.255.255.255(支持千万数量级设备)
- 172.16.0.0 ~ 172.31.255.255(支持百万数量级设备)

- 192.168.0.0 ~ 192.168.255.255(支持万数量级设备)

**外网地址：全球公网唯一**

NAT技术将内网IP地址的网络请求，在本地路由器内部进行了一次IP地址和端口的转换，当接收到返回结果之后，再将IP地址和端口转换回来，发送给请求的设备。映射的表，称为**NAT**。

![image-20211221140050225](https://isbut-blog.oss-cn-shenzhen.aliyuncs.com/markdown-img/image-20211221140050225.png)

## ICMP协议

辅导IP协议进行数据传输，**可以报告错误信息或者异常情况，ICMP的报文数据段是通过封装在IP数据报中进行数据传输的，可分为ICMP报文首部和ICMP报文数据。**

![image-20211221140118982](https://isbut-blog.oss-cn-shenzhen.aliyuncs.com/markdown-img/image-20211221140118982.png)

**ICMP报文首部**

![image-20211221140130875](https://isbut-blog.oss-cn-shenzhen.aliyuncs.com/markdown-img/image-20211221140130875.png)

- **类型**：主要指的是ICMP报文的种类
- **代码**：主要是指，不同的ICMP报文种类具体有哪些错误

- **校验和**：主要是校验报文在整个传输中，是否存在错误

**ICMP协议报文的两个种类**

**差错报告报文**

![image-20211221140145565](https://isbut-blog.oss-cn-shenzhen.aliyuncs.com/markdown-img/image-20211221140145565.png)

- **网络不可达**：如果整个网络不可达，就会报告一个类型为3，具体代码为0的ICMP协议报文
- **主机不可达**：如果计算机状态（如关机等）有错误，就会出现主机不可达的情况

- **网络重定向**：传输给某一个网络的数据，可能不能走该网络了，需要进行重定向
- **主机重定向**：如果发送的报文，主机告知不能处理，请发送到另外一个主机

**询问报文**

![image-20211221140155098](https://isbut-blog.oss-cn-shenzhen.aliyuncs.com/markdown-img/image-20211221140155098.png)

- **回送请求或应答**：主要是验证网络是否通。假设计算机A要和计算机B进行通信，A会发送一个空的数据给B，如果B收到，就给一个回应
- **时间戳请求或应答**：当需要进行时间同步时，会用到这个

**Ping原理**

主要应用ICMP的**询问报文**，它会发送**回答请求或应答**类型的报文，并且通过报文中的时间可以计算延迟。

**traceroute原理**

探测IP数据报在网络中走的路径，**traceroute利用了TTL为0时的设备要发送一个ICMP终点不可达的差错报文，这样源主机就知晓了传播路径。**

故将其TTL递增从而发送IP数据报。

## 路由算法

路由器中存在路由表，包含目的网络IP、子网掩码、下一跳IP地址、接口等，主要通过路由算法来得到信息并规划最佳路径。

**自治系统（AS）**：处于一个管理机构下的网络设备群，实现了透明性，把路由协议分为了AS内部使用的内部路由算法（RIP、OSPF）与外部路由算法（BGP）。

**内部路由算法**

- 静态路由算法：

  - 方式：管理员手工配置
  - 优点：简便可靠，在较小网络范围内运行效果好
  - 缺点：路由更新慢，不适用于大型网络

- 动态路由算法：

  - 方式：路由器彼此交换信息，按照路由器算法优化出路由项

  - 优点：路由更新快，适用于大型网络

  - 缺点：算法复杂，增加网络负担

  - 全局性：

    - 链路状态路由算法
    - 典型应用：OSPF协议
    - 特点：所有路由器掌握完整的网络拓扑和链路费用情况，每个路由器知道完整拓扑

  - 分散性：

    - 距离向量路由算法
    - 典型应用：RIP协议
    - 特点：路由器只掌握物理相连的邻居及费用情况，即只知道周围的拓扑情况

**外部路由算法**：BGP，边际网关协议，将路由划分为多个AS系统，能减少系统内路由器的网络负担，通过BGP（发言人）与外部AS进行信息通信。

### RIP协议

RIP是使用**DV算法**的一种路由协议，将**网络跳数**作为DV算法的距离，**每隔30s**交换一次路由信息，将**跳数>15**的路由认为不可达路由。

**DV算法：每个节点与相邻节点交换向量Di和Si的信息，根据交换的信息更新自己的节点信息，目的是：计算D的距离最小值。**

- Di描述的是当前节点到别的节点的**距离**
- Si描述的是当前节点到别的节点的**下一个节点**

![1609426012317-db894a70-0622-430e-bccc-6e21b0e92bcb](https://isbut-blog.oss-cn-shenzhen.aliyuncs.com/markdown-img/1609426012317-db894a70-0622-430e-bccc-6e21b0e92bcb.png)

- 初始路由收到另一个路由信息之后，另一个路由的信息先进行更新，然后和初始路由进行对比，如果新信息的距离更小，则更新

![1609426011819-23072cbd-6175-49ad-a982-9778708677dc](https://isbut-blog.oss-cn-shenzhen.aliyuncs.com/markdown-img/1609426011819-23072cbd-6175-49ad-a982-9778708677dc.png)

**缺点**

当相邻节点宕机的时候，由于信息只与相邻节点交换，故会造成循环更新信息，直到达到不可达的距离，称为**故障信息传递慢**

![1609426012160-10790bce-5df2-4fcf-8fc8-96f4251e0c2c](https://isbut-blog.oss-cn-shenzhen.aliyuncs.com/markdown-img/1609426012160-10790bce-5df2-4fcf-8fc8-96f4251e0c2c.png)

### OSPF协议

OSPF协议是链路状态路由算法，其基于迪杰斯特拉算法（Dijkstra）。

- 特点一：向**所有的路由器发送消息**
- 特点二：描述该路由与相邻路由器的链路状态
- 特点三：**只有当链路状态发生变化时，才发送更新消息**

**五种消息类型**

- 问候消息：确认可达性
- 链路状态数据库描述信息：向相邻路由器发送自己的链路状态数据库的所有链路状态的消息
- 链路状态请求消息：向相邻路由器请求链路状态消息
- 链路状态更新信息：对于状态更新，每个路由器都会广播到网络中
- 链路状态确认消息：对链路状态更新的确认

**OSPF过程**

```
路由器接入网络，向相邻路由器发出问候消息
确认可达性后，彼此交流当前的链路状态消息，与其他路由器达到一致的状态
此时，路由器会广播更新的消息到网络中，以及接收更新信息
```

**Dijkstra算法**

```plain
初始化两个集合(S,U)（S为只有初始顶点点A的集合，U为其它顶点的集合）
如果U不为空，对U集合顶点进行距离的排序，并取出距离A最近的一个顶点D
将顶点D放入S集合，更新通过顶点D到达U集合所有点的距离（如果距离更小则更新，否则不更新）
重复步骤2
直到U集合为空，整个算法过程完成
```

### 对比RIP协议和OSPF协议

![img](https://isbut-blog.oss-cn-shenzhen.aliyuncs.com/markdown-img/1609427682274-17b16d7e-22e0-4cbc-b99b-a7b2c1a11744.png)

### BGP协议

BGP协议是运行在自治系统（AS）之间的一种协议。在AS中使用BGP的理由：

- 互联网规模大，若使用链路状态协议，则每个路由器存储过多的链路状态数据，运行算力不足
- AS内部中使用了不同的路由协议
- AS之间需要考虑其他因素，例如国家政策、信息安全等

而BGP协议，主要会有个**BGP发言人**。

- BGP并不关心内部网络拓扑
- 在AS之间通过BGP发言人交流信息
- BGP发言人可以人为配置策略

![img](https://isbut-blog.oss-cn-shenzhen.aliyuncs.com/markdown-img/1609428270496-5dadfc16-ab4e-4c5a-bd51-00154128ae86.png)

## ARP协议

地址解析协议，把网络层32位的IP转换成数据链路层48位的MAC地址。其中会存在一个**ARP缓存表**，记录IP地址与MAC地址的映射。

ARP协议是直接封装在数据链路层的数据帧中的，但ARP协议用到了IP地址，故属于网络层协议，且APR协议主要是数据链路层和网络层配合使用的。

![oQqWrV ](https://isbut-blog.oss-cn-shenzhen.aliyuncs.com/markdown-img/oQqWrV%20.png)

**ARP攻击**

- `ARP 泛洪攻击`：通过向网关发送大量 ARP 报文，导致网关无法正常响应。发送大量的 ARP 请求报文与大量虚假的 ARP 响应报文，从而造成网关部分的 CPU 利用率上升难以响应正常服务请求，而且网关还会被错误的 ARP 缓存表充满导致无法更新维护正常 ARP 缓存表，消耗网络带宽资源。
- `ARP 欺骗主机攻击`：攻击者通过 ARP 欺骗使得局域网内被攻击主机发送给网关的流量信息实际上都发送给攻击者。主机刷新自己的 ARP 使得在自己的ARP 缓存表中对应的 MAC 为攻击者的 MAC，这样一来其他用户要通过网关发送出去的数据流就会发往主机这里，这样就会造成用户的数据外泄。
- `欺骗网关的攻击`: 欺骗网关就是把别的主机发送给网关的数据通过欺骗网关的形式使得这些数据通过网关发送给攻击者。这种攻击目标选择的不是个人主机而是局域网的网关，这样就会攻击者源源不断的获取局域网内其他用户韵数据．造成数据的泄露，同时用户电脑中病毒的概率也会提升。
- `中间人攻击`: 中间人攻击是同时欺骗局域网内的主机和网关，局域网中用户的数据和网关的数据会发给同一个攻击者，这样，用户与网关的数据就会泄露。
- `IP地址冲突攻击`: 通过对局域网中的物理主机进行扫描，扫描出局域网中的物理主机的 MAC 地址，然后根据物理主机的 MAC 进行攻击，导致局域网内的主机产生 IP 地址冲突，影响用户的网络正常使用。

## RARP协议

逆地址解析协议，将48位的MAC地址转换为32位的IP地址。

![](https://isbut-blog.oss-cn-shenzhen.aliyuncs.com/markdown-img/oQLoef.png)

# 传输层

- 提供进程和进程之间的逻辑通信
- 复用和分用
- 对收到的报文进行差错检测

**寻址与端口**

为了实现传输层的复用，我们对于应用进程有了端口号的概念，端口号长度为16 bit，能表示65535个不同的端口号。套接字（IP地址+端口号）唯一标识了网络中的一个主机中的特定进程。

**端口分类**

**服务端使用端口号**

- 熟知端口号：0~1023

| 应用程序   | FTP  | TELNET | SMTP | DNS  | TFTP | HTTP | SNMP |
| ---------- | ---- | ------ | ---- | ---- | ---- | ---- | ---- |
| 熟知端口号 | 21   | 23     | 25   | 53   | 69   | 80   | 161  |

- 登记端口号：1024-49151

**客户端使用的端口号**：49152~65536，仅在客户进程运行时候才动态选择

### UDP

UDP只是在IP数据报上增加了**复用分用和差错检测功能**。

特点：

- UDP是**无连接**的，减少开销和发送数据之前的时延
- UDP使用最大努力交付，即**不保证可靠交付**
- UDP是面向报文的，不进行分割和合并报文，故大小需合适
- UDP没有拥塞控制，具有实时性
- UDP首部开销小，只有8个字节，而TCP是20个字节

**UDP首部格式**

![202109111549556912.png](https://isbut-blog.oss-cn-shenzhen.aliyuncs.com/markdown-img/202109111549556912.png)

1. UDP长度：整个数据报的长度
2. UDP检验和：检测整个数据报是否有错，错误则丢弃，校验和是利用**UDP的伪首部**计算而来的

分用时，若找不到对应的目的端口号，则丢弃报文，发送ICMP端口不可达的差错报文。

### TCP

1. TCP是面向连接（虚连接）、面向字节流的协议，应用于点对点通信
2. TCP提供可靠交付的服务，具有拥塞控制、流量控制等功能
3. TCP提供全双工通信，双方均提供缓存区用于数据处理

**首部格式**

![202109111549584145](https://isbut-blog.oss-cn-shenzhen.aliyuncs.com/markdown-img/202109111549584145.png)

- 序号：TCP是面向字节流的，每个字节都有唯一的序号
- 确认号：期待收到的数据首字节序号，表示之前的字节已经收到
- 数据偏移：TCP报文段数据距离起始处的距离
- 紧急位URG：URG=1时，标记报文段中有紧急数据，是高优先级数据，不应在缓存中排队，而应立即发送
- 确认位ACK：ACK时确认号字段有效，在连接建立后，所有报文段的ACK均置为1
- 推送位PSH：PSH=1时，接收方尽快交付接收应用进程，不再等到缓存填满再向上交付。
- 复位RST：RST=1时，表明TCP连接中出现严重差错，必须释放连接，重新建立传输链接；也可用来拒绝连接。
- 同步位SYN: SYN=1时，表明是一个连接请求/连接接受报文。
- 终止位FIN:FIN=1时，表明此报文段发送方数据已发完，要求释放连接。
- 窗口：指的是发送本报文段的一方的接收窗口，即现在允许对方发送的数据量。
- 检验和：检验首部+数据，检验时要加上12B伪首部，第四个字段，也就是TCP的协议号为6。
- 紧急指针: URG=1时才有意义，指出本报文段中紧急数据的字节数。
- 选项：最大报文段长度MSS、窗口扩大、时间戳、选择确认…MSS是数据字段的最大长度。

#### **TCP可靠传输**

网络层仅提供尽最大努力交付的可靠传输。因而传输层可以通过TCP协议实现可靠传输。如果使用的是UDP协议，那只能依靠应用层提供可靠传输了。

可靠：保证接收方进程从缓存区读出的字节流与发送方发出的字节流一样。

**实现机制**：校验、序号、确认、重传。

**校验**和UDP一样，添加伪首部。

**序号**指的是一个报文段第一个字节的序号。

发送方发送完报文后并不立即从缓存移除，而是继续保存。直至**重传时间**内收到确认后才移除，否则重传。

#### 确认重传

**重传时间：**TCP采用自适应算法，动态改变重传时间RTTs（加权平均往返时间)。

**确认ACK：**每当比期望序号大的失序报文段到达时，发送一个**冗余ACK**，指明下一个期待字节的序号。

发送方收到**3个冗余ACK**，于是便认为报文段已丢失，重传报文段。这种技术称为**快速重传**。

**停止等待协议**：收到确认号后才继续发送报文段，超时重传由**超时定时器所支持**，对信道利用率低。

![img](https://isbut-blog.oss-cn-shenzhen.aliyuncs.com/markdown-img/1609430674576-79c7ed8d-eebb-47d9-96e1-19e252936c8f.png)

**连续ARQ协议**：在停止等待协议基础上而来，采用批量发送和确认的方法提升效率，称为**滑动窗口**，并且采用**累计确认**的方法来对报文进行确认，减小了确认报文的开销，**只要收到了某一个报文的确认消息，就表示说这个消息之前的所有消息都已经收到了确认消息**。

![img](https://isbut-blog.oss-cn-shenzhen.aliyuncs.com/markdown-img/1609430674531-99842426-73f6-4b95-a246-771c632e5007.png)

但ARQ也有一个缺点，即当缺少报文段后，无论此报文段后的数据是否接收到，每次都得重传此报文段以后的数据，造成开销大。故引入了**选择重传SACK**进行报文段的重发。

#### TCP流量控制

**流量控制**指让发送方降低发送速度，让接收方来得及接收，避免严重的丢包现象。

**滑动窗口机制**

接收方根据自己**可用缓冲区大小**，动态调整发送方的发送窗口大小，通过**窗口字段**告知，发送方的**发送窗口取接收窗口rwnd和拥塞窗口cwnd的最小值。**

当窗口字段为0时，则会开启**持续计时器**，若持续计时器设置的时间到期，则会发送零窗口探测报文段；若窗口仍为0，则重置持续计时器。

#### TCP拥塞控制

当带宽被占用完时，网络性能变坏，吞吐量下降，故**拥塞控制从全局性控制数据的收发量。**拥塞控制采用了4种算法，分别是**慢开始、拥塞避免、快重传、快恢复。**

![2021091115500351910.png](https://isbut-blog.oss-cn-shenzhen.aliyuncs.com/markdown-img/2021091115500351910.png)

#### TCP三次握手

![202109111549592746.png](https://isbut-blog.oss-cn-shenzhen.aliyuncs.com/markdown-img/202109111549592746.png)
- 第一次握手：客户端发送**连接请求报文段**，无应用层数据。SYN=1，seq=x(随机)
- 第二次握手：服务器端为该TCP连接**分配缓存和变量（半连接资源）**，并向客户端返回**确认报文段**，允许连接，无应用层数据。SYN=1，ACK=1，seq=y(随机)，ack=x+1
- 第三次握手：客户端为该TCP连接**分配缓存和变量**，并向服务器端返回确认的确认，可以携带数据。SYN=0，ACK=1，seq=x+1，ack=y+1

**随机序列号的原因**

- 分辨历史报文，防止产生数据混乱
- 安全性，防止黑客伪造相同序列号的TCP报文发送给对方

**SYN洪泛攻击**

攻击者发送大量的第一次握手连接而不确认，大量消耗服务器的半开连接区资源。

解决方法：

1. 采用SYN cookies，对第一次握手的信息与客户端的信息进行处理得到cookies值，将cookies值附带到第二次握手数据报中，并且不分配半开连接区资源，直到客户端发来的第三次握手cookies经过验证后正确才分配资源。
2. 修改 Linux 内核参数，控制队列大小和当队列满时应做什么处理。

#### TCP四次挥手

![202109111549598717 (1)](https://isbut-blog.oss-cn-shenzhen.aliyuncs.com/markdown-img/202109111549598717%20(1).png)

- 第一次挥手：客户端发送**连接释放报文段**，停止发送数据，主动关闭TCP连接。FIN=1，seq=u（u表示之前已传送数据最后一个字节的序号再加一)
- 第二次挥手：服务器端回送一个确认报文段，客户到服务器这个方向的连接就释放了—―半关闭状态。ACK=1，seq=v，ack=u+1（v表示之前已接收数据最后一个字节的序号再加一）
- 第三次挥手：服务器端发完数据，就发出连接释放报文段，主动关闭TCP连接。FIN=1，ACK=1，seq=w，ack=u+1（w取决于第二步之后服务器所发送的数据量的多少）
- 第四次挥手：客户端回送一个确认报文段，再等到**时间等待计时器**设置的2MSL（最长报文段寿命）后，连接彻底关闭

**等待计时器**

**会等待2MSL（MSL（MAX Segment Lifetime）最长报文段寿命），通常MSL是设置成2min的**，在等待计时器这个状态中，连接是不会释放的，也就是不会释放当前占用的端口。只有在等待计时器状态结束之后才会释放这个端口。

- **确保连接正确关闭，即让第四次挥手的报文可以正确的到达对方，如果没到达，接收方就会重新发送一次第三次挥手的报文**
- **确保当前连接的所有报文都已经过期了**

**TIME-WAIT状态过多**

危害：内存资源占用、对端口资源的占用。

解决：修改内核参数，使得TIME-WAIT状态可以为新连接复用、修改TIME-WAIT时间

# 应用层

应用层协议是为了解决应用之间通信的问题，故定义了

- 应用进程交换的报文类型，如请求报文和响应报文
- 各种报文类型的语法，如报文中的各个字段以及详细描述

- 字段的语义，即包含在字段中的信息的含义
- 进程何时，如何发送报文，以及对报文进行响应的规则

应用层模型可分为C/S模型、P2P模型。

## DNS

域名系统DNS是互联网使用的**命名系统**，因IP记忆困难，故采用域名记忆相应主机。而机器在处理IP数据报时采用IP地址，而不采用域名，因为域名解析IP并不是固定的。

互联网采用**层次树状结构**的命名方法，并使用**分布式**的域名系统DNS。而运行域名到IP地址的解析的服务器程序的机器，我们称之为**域名服务器**。

![img](https://isbut-blog.oss-cn-shenzhen.aliyuncs.com/markdown-img/1609596951548-c053b805-f44a-45b3-b48a-86c6a0431694.webp)

**域名服务器分类**

- 根域名服务器：最高层次，最重要的域名服务器
- 顶级域名服务器：诸如com cn gov 这种的

- 权限域名服务器：负责一个区的域名服务器
- 本地域名服务器。当一台主机发出DNS查询请求，这个查询请求报文就发送给本地域名服务器。（一般每个ISP都可以拥有一个）

**DNS解析过程**

在本机中不仅浏览器中具有DNS缓存，本机的host文件也可以修改DNS本机解析，并且本地域名服务器中也具有**高速缓存**。

**递归查询**：若本地域名服务器查询不到结果，则按层级请求，直至有结果，按层级返回

**迭代查询**：若本地域名服务器查询不到结果，则会指示主机请求上级域名服务器，直至有结果由请求的域名服务器直接返回结果

![202109111550079324](https://isbut-blog.oss-cn-shenzhen.aliyuncs.com/markdown-img/202109111550079324.png)

## FTP

常见的文件传输协议有：文件传输协议FTP、简单文件传输协议TFTP，而**TFTP适用于UDP协议，FTP是基于TCP的C/S协议**。

**FTP工作原理**

FTP只提供文件传送的一些基本的服务，主要功能是**减少或消除在不同操作系统下处理文件的不兼容性**。

FTP协议可分为客户端和服务端，并且一个服务端可以为多个客户端提供服务。

服务端分两类：主进程，从属进程。主进程负责接受新请求，若干个从属进程负责处理单个进程。客户端和服务端都有两个从属进程：**控制进程和数据传送进程**，**建立会话后，数据连接是根据文件传输是否完成来决定是否断开。**

![202109111550099245.png](https://isbut-blog.oss-cn-shenzhen.aliyuncs.com/markdown-img/202109111550099245.png)

控制连接使用端口号永远为21，而数据连接是否要使用20，与**传输模式**有关。

- **主动**方式使用TCP 20端口
- **被动**方式由服务器和客户端自行协商决定（端口>1024)

**FTP传输模式**

- 文本模式：ASCII模式，以文本序列传输数据;
- 二进制模式：Binary模式，以二进制序列传输数据。

## 电子邮件协议

![202109111550107396.png](https://isbut-blog.oss-cn-shenzhen.aliyuncs.com/markdown-img/202109111550107396.png)

- 用户代理：电子邮件客户端软件
- 邮件服务器：具有发送和接收邮件功能，也可作为客户端
- 协议：发送邮件使用SMTP协议，接收邮件使用POP3和IMAP协议

**SMTP协议**

SMTP规定了两个相互通信的进程如何交换信息，两个进程分别是负责发送邮件、接收邮件的进程。

SMTP协议使用TCP连接，使用的端口号是25，使用C/S模式。

SMTP通信要经历三个阶段：连接建立、邮件发送、连接释放。

**缺点**

- SMTP不能传送可执行文件或者其他二进制对象
- SMTP仅限于传送7位ASCII码，不能传送其他非英语国家的文字
- SMTP服务器会拒绝超过一定长度的邮件

为了弥补以上缺点，我们可以使用通用因特网邮件扩充MIME。

**POP3协议**

POP3协议使用TCP连接，使用的端口号是110，使用C/S模式。

POP3的工作方式有下载并保留（在服务器）和下载并删除。

**IMAP协议**

网际报文存储协议，当用户主机上的IMAP客户程序打开IMAP服务器的邮箱时，用户可以看到邮箱的首部，若用户需要打开某个邮件，该邮件才上传到用户的计算机上。

## DHCP协议

计算机联网需要配置的项目有：IP地址、子网掩码、默认路由器的IP地址、域名服务器的IP地址。

**动态IP**：IP资源宝贵，等到上网时，向ISP申请IP地址进行上网。

**静态IP**：长期分配给一台计算机或网络设备固定的IP地址。

DHCP（动态主机配置协议，**即插即联网**）是一个局域网的网络协议。指的是由服务器控制一段lP地址范围，客户机登录服务器时就可以自动获得服务器分配的lP地址和子网掩码。

![img](https://isbut-blog.oss-cn-shenzhen.aliyuncs.com/markdown-img/994417-20160816191943515-1882123637.png)

**过程**

1. **发现阶段**：客户端在DHCP服务配置完成后，由于无IP地址，会**发送discover广播报文**，源地址为0.0.0.0，目的地址为255.255.255.255。网络上的所有主机都会收到该DHCP Discovery报文，只有DHCP Server会响应该报文
2. **DHCP Server Offer响应阶段**：DHCP Server收到discover报文后，会给DHCP Client**发送offer报文**，告诉DHCP Client，该DHCP Server拥有资源，可以提供DHCP服务
3. **DHCP Client请求使用阶段**：当DHCP Client收到offer报文时，选择其中一个，**发送request请求报文**
4. **DHCP Server确认使用阶段**：当对应的DHCP Server收到request报文后，会将该资源分配给客户端，**发送响应的ack报文**
5. **DHCP Client重新登录网络阶段**：客户端会发送之前的DHCP Request报文，当DHCP Sever收到并确认资源可用后，回复ACK报文；**当资源无法分配时，回复NAK报文**，客户端重复步骤1
6. **DHCP Client续约阶段**：当租约期限过了一半后，DHCP Client都会**发送DHCP Renew报文**来续约租期。

## HTTP协议

**WWW**

万维网WWW (World Wide Web）是一个大规模的、联机式的信息储藏所 / **资料空间**，是无数个网络站点和网页的集合。

**总结：WWW = Web = HTML + HTTP + URL**

- URL：统一资源定位符，一个资源的网络地址，代表资源的路径地址，提供了相关的访问协议，是URI的子集
- URI：统一资源标识符，一个资源的唯一标识，代表资源的名称

HTTP优点：无连接、无状态、灵活、简单快速

HTTP缺点：无连接、不安全、明文传输、队头阻塞

**相关概念**

**串行连接**：HTTP有无连接特性，每次连接只能处理一个请求，收到后立即断开连接，HTTP/1.0就是如此，每次连接都要三次握手、四次挥手，增大了通信开销。

**持久连接**：即长连接，只要建立连接后，两端都没有提出断开连接，则持久保持TCP连接状态，其他请求可以复用这个连接，HTTP/1.1实现了所有连接都是长连接。

- **优点**：
  - `减少CPU及内存的使用`，无需经常建立和关闭连接
  - `支持管道化`的请求及响应模式
  - `减少网络堵塞`，因为减少了TCP请求
  - `减少了后续请求的响应时间`，因为无需等待建立和关闭连接的过程
  - 发生错误时，也`可在不关闭连接的情况下进行错误提示`
- **缺点**：
  - 保持连接后，若时间过长影响服务器并发数，消耗服务器资源
  - 可能造成队头阻塞
- **解决方案**：
  - **客户端请求头声明**：`Connection: close`，本次通信后就关闭连接
  - **服务端配置**：如Nginx，设置`keepalive_timeout`设置长连接超时时间，`keepalive_requests`设置长连接请求次数上限
  - **系统内核参数设置**：调整保活计时器的相关规则

**管道化**：即不用等待响应返回而发送下个请求，但服务器按请求顺序返回响应。

**HTTP/2.0 多路复用**：每个HTTP请求都有一个序列标识符，浏览器/服务器可以并发多个请求，收到数据后，按标识符重新排列成不同的请求报文。

**WebSocket**：由HTML5提出的客户端和服务端通讯的全双工协议，服务器可以实现主动推送。

![eff83eaed19e4823ae51886af64bd86e~tplv-k3u1fbpfcp-watermark](https://isbut-blog.oss-cn-shenzhen.aliyuncs.com/markdown-img/eff83eaed19e4823ae51886af64bd86e~tplv-k3u1fbpfcp-watermark.png)

### HTTP各版本

**HTTP/1.0**

使用在一些较为简单的网页上和网络请求上，每次请求都打开一个新的TCP连接，收到响应后立即断开。

**HTTP/1.1**

- 引入了更多的缓存控制策略，如Entity tag，If-Unmodified-Since, If-Match, If-None-Match等
- 允许范围请求，即在请求头加入**Range**头部
- 请求消息和响应消息都必须包含**Host**头部，以区分不同虚拟主机的域名
- 默认开启持久连接，即请求头中的**Connection: Keep-Alive**

**HTTP/2.0**

HTTP/2.0主要有两个重要概念，分别是帧和流。帧代表数据传输的最小单位，每个帧都有序列标识表明该帧属于哪个流，流也就是多个帧组成的数据流，每个流表示一个请求。

- **新的二进制格式**，HTTP/1.x的解析是基于文本的，对于不同的场景考虑点很多，而采用了二进制，只需要识别0和1的组合，方便且强大
- **多路复用**：在TCP连接中可以发送多个请求，服务端则可以通过帧中的标识知道该帧属于哪个流（即请求），通过重新排序还原请求。多路复用允许并发的发起多个请求，每个请求及该请求的响应不需要等待其他的请求或响应。
- **头部压缩**：HTTP/1.x的请求和响应头部带有大量信息，造成开销。HTTP/2.0使用encoder来减少头部大小，双方缓存一份头部表，既避免了重复头部的传输，又减小了需要传输的大小。
- **服务端推送**：指把客户端需要的css、js、img资源伴随着页面请求而推送给客户端，避免了客户端重复请求的步骤。

**HTTP/3.0**

HTTP/2.0的多路复用一般来说同一个域名只需要采用一个TCP连接，但当TCP连接出现丢包情况后，整个TCP都得等待重传，导致后面的所有数据都被阻塞。

HTTP/1.x由于可以开启多个TCP连接，出现问题只会影响其中一个连接，剩余的还可以继续传输数据。

基于底层TCP协议的特性，Google基于UDP推出了一个QUIC协议，并且使用在了HTTP/3上，在UDP基础上新增了多路复用、0-RTT、使用TLS 1.3加密、流量控制、有序交付、重传等。

- **避免包阻塞**：多个流的数据包在TCP连接上传输时，若一个流中的数据包传输出现问题，TCP需要等待该包重传后，才能继续传输其它流的数据包。但在基于UDP的QUIC协议中，不同的流之间的数据传输实现了互不干扰，某个流的数据包在出问题需要重传时，并不会对其他流的数据包传输产生影响。
- **快速重启会话**：QUIC基于特有的UUID来标记每次连接，当网络发生变化，而UUID不变时，则不需要握手，继续传输数据。

### HTTP报文

HTTP报文分为请求报文、响应报文。

**请求报文** 是由请求行、请求首部和内容实体构成。

![img](https://isbut-blog.oss-cn-shenzhen.aliyuncs.com/markdown-img/56b4cc008d674181a1aaf6c9f96aa8c8~tplv-k3u1fbpfcp-watermark.png)

**响应报文** 是由状态行、响应首部和内容实体构成。

![d225058ebc3744ce843cca2d42ef42d5~tplv-k3u1fbpfcp-watermark](https://isbut-blog.oss-cn-shenzhen.aliyuncs.com/markdown-img/d225058ebc3744ce843cca2d42ef42d5~tplv-k3u1fbpfcp-watermark.png)

**请求方法**

- GET：一般用于获取服务器资源
- POST：一般用于传输实体主体
- PUT：一般用于传输文件
- DELETE：一般用于删除文件
- HEAD：一般用于获取报文首部，不返回报文主体
- OPTIONS：一般用于询问请求URI资源支持的方法



**状态码**

HTTP状态码表示客户端HTTP请求的返回结果、标识服务器处理是否正常、表明请求出现的错误等。

| 2XX  | 成功（这系列表明请求被正常处理了）                     |
| ---- | ------------------------------------------------------ |
| 200  | OK，表示从客户端发来的请求在服务器端被正确处理         |
| 204  | No content，表示请求成功，但响应报文不含实体的主体部分 |
| 206  | Partial Content，进行范围请求成功                      |

| 3XX  | 重定向（表明浏览器要执行特殊处理）                           |
| ---- | ------------------------------------------------------------ |
| 301  | moved permanently，永久性重定向，表示资源已被分配了新的 URL  |
| 302  | found，临时性重定向，表示资源临时被分配了新的 URL            |
| 304  | not modified，表示服务器允许访问资源，但请求未满足条件的情况（与重定向无关） |


| 4XX  | 客户端错误                                                   |
| ---- | ------------------------------------------------------------ |
| 400  | bad request，请求报文存在语法错误                            |
| 401  | unauthorized，表示发送的请求需要有通过 HTTP 认证的认证信息   |
| 403  | forbidden，表示对请求资源的访问被服务器拒绝，可在实体主体部分返回原因描述 |
| 404  | not found，表示在服务器上没有找到请求的资源                  |

| 5XX  | 服务器错误                                                   |
| ---- | ------------------------------------------------------------ |
| 500  | internal sever error，表示服务器端在执行请求时发生了错误     |
| 501  | Not Implemented，表示服务器不支持当前请求所需要的某个功能    |
| 503  | service unavailable，表明服务器暂时处于超负载或正在停机维护，无法处理请求 |

**首部字段**

| 通用首部          | 作用（请求报文和响应报文都可能使用）                         |
| ----------------- | ------------------------------------------------------------ |
| Cache-Control     | 控制缓存的行为：`no-cache`（强制向服务器再次验证）、`no-store`（不做任何缓存）、`max-age=111111`（资源可缓存最大时间 秒）、`public`（客户端、代理服务器都可利用缓存）、`private`（代理服务器不可用缓存） |
| Connection        | 浏览器想要优先使用的连接类型： `keep-alive close`（开启和关闭持久连接） |
| Date              | 创建报文时间                                                 |
| Pragma            | 只用于请求报文，客户端要求中间服务器不返回缓存的资源         |
| Via               | 代理服务器相关信息，每经过一个代理服务器就会添加相关信息，用逗号分割 |
| Transfer-Encoding | 传输编码方式：`chunked`分块传输                              |
| Upgrade           | 要求客户端使用的升级协议，需配合`Connection: Upgrade`一起使用：`websocket` |
| Warning           | 缓存相关问题的警告                                           |

| 请求首部            | 作用（请求报文专用）                                         |
| ------------------- | ------------------------------------------------------------ |
| Accept              | 能正确接收的媒体类型：`application/json` `text/plain`        |
| Accept-Charset      | 能正确接收的字符集: `unicode-1-1`                            |
| Accept-Encoding     | 能正确接收的编码格式列表：`gzip deflate`                     |
| Accept-Language     | 能正确接收的语言列表：`zh-cn,zh;1=0.9,en,1=0.8`              |
| Authorization       | 客户端认证信息：`Bearer dSdSdFFlsfdjasd123`，一般存token用   |
| Cookie              | 发送给服务器的Cookie信息                                     |
| Host                | 服务器的域名，用于区分单台服务器多个域名的虚拟主机，是HTTP/1.1唯一必须包含的字段。 |
| If-Match            | 两端资源标记比较，只有判断条件为真服务端才会接受请求：`If-Mach: "123456`，和服务端文件标记比较 |
| If-Modified-Since   | 本地资源未修改返回 304（比较时间）                           |
| If-None-Match       | 本地资源未修改返回 304（比较标记）                           |
| User-Agent          | 客户端信息                                                   |
| Range               | 请求某个内容的一部分，配合`If-Range`使用                     |
| Referer             | 请求发起页面的原始URI                                        |

| 响应首部           | 作用（响应报文专用）                                    |
| ------------------ | ------------------------------------------------------- |
| Accept-Ranges      | 告知客户端服务器是否可接受范围请求，是`bytes`，否`none` |
| Age                | 资源在代理缓存中存在的时间                              |
| ETag               | 资源标识，资源发生变化时标识也会发生改变                |
| Location           | 客户端重定向到某个 URL                                  |
| Server             | 服务器名字：`Apache Nginx`                              |
| Set-Cookie         | 需要存在客户端的信息，一般用于识别用户身份              |

| 实体首部         | 作用（补充请求报文或响应报文相关信息）                       |
| ---------------- | ------------------------------------------------------------ |
| Allow            | 资源的正确请求方式：`GET HEAD POST`                          |
| Content-Encoding | 内容的编码格式：`gzip deflate`                               |
| Content-Language | 内容使用的语言：`zh-CN`                                      |
| Content-Length   | request body 长度（即实体主体的大小）：                      |
| Content-Range    | 响应主体的内容范围                                           |
| Content-Type     | 内容的媒体类型（如'application/json;charset=UTF-8'则会发送预检请求） |
| Expires          | 内容的过期时间                                               |
| Last_modified    | 内容的最后修改时间                                           |

**两种请求**

浏览器发送 CORS 请求（跨域请求）时, 会将请求分为简单请求与复杂请求.

简单请求:

1. 请求的方法只能为HEAD、GET、POST
2. 无自定义请求头
3. `Content-Type`只能是这几种：

```
text/plain` `multipart/form-data` `application/x-www-form-urlencoded
```

复杂请求:

1. PUT, Delete 方法的 ajax 请求
2. 发送 JSON 格式的 ajax 请求(比如post数据)
3. 带自定义头的 ajax 请求

如果是简单请求, 则会先执行, 后判断。执行的过程大致如下:

浏览器检测到请求是 CORS 请求, 添加一个origin字段(其中包含源信息: 协议、域名、端口) ———》服务端收到后作相应的处理(对比origin, 服务端判断这个源是否接受)返回结果给浏览器  ———》 浏览器检查响应头是否允许跨域信息————》 允许,返回数据；不允许, 则浏览器抛出相应的错误信息。

复杂请求在发生请求时, 如果是 CORS 请求，浏览器预先发送一个 option 请求。浏览器这种行为被称之为预检请求。

## HTTPS协议

由于HTTP是明文传输，故存在不安全性，采用HTTPS（超文本传输安全协议），即**HTTP+SSL/TLS**。

![86d024cdc8a54cb9960dca344ff3d512~tplv-k3u1fbpfcp-watermark](https://isbut-blog.oss-cn-shenzhen.aliyuncs.com/markdown-img/86d024cdc8a54cb9960dca344ff3d512~tplv-k3u1fbpfcp-watermark.png)

**对称加密算法**

加密与解密采用同一个密钥，如**AES,DES**，过程：

1. 浏览器给服务器发送一个随机数`client-random`和一个支持的加密方法列表
2. 服务器给浏览器返回另一个随机数`server-random`和双方都支持的加密方法
3. 然后两者用加密方法将两个随机数混合生成密钥，这就是通信双上加解密的密钥

缺点：交换随机数和加密方法过程中可能被窃取。

**不对称加密算法**

密钥分为公钥和私钥，一个密钥加密后的数据，只能用另一个密钥解密，如**RSA**，过程：

1. 浏览器给服务器发送一个随机数`client-random`和一个支持的加密方法列表
2. 服务器把另一个随机数`server-random`、`加密方法`、`公钥`传给浏览器
3. 然后浏览器用公钥将两个随机数加密，生成密钥，这个密钥只能用`私钥`解密

缺点：性能比对称加密差很多

TLS（SSL升级版）采用了`两种算法的混合加密`。**通过 非对称加密算法 交换 对称加密算法 的密钥，交换完成后，再使用对称加密进行加解密传输数据**，保证了会话的机密性。过程：

- 浏览器给服务器发送一个随机数`client-random`和一个支持的加密方法列表
- 服务器把另一个随机数`server-random`、`加密方法`、`公钥`传给浏览器
- 浏览器又生成另一个随机数`pre-random`，并用公钥加密后传给服务器
- 服务器再用私钥解密，得到`pre-random`
- 浏览器和服务器都将三个随机数用加密方法混合生成最终密钥

即便被截持，中间人没有私钥就拿不到`pre-random`，就无法生成最终密钥。**但如果拿到的公钥是中间人的，数据还是会被窃取，故采用数字证书保证信任。**

**数字证书**

采用了**摘要算法**来帮我们**验证服务器身份**。

- 摘要算法：**MD5算法**、**散列函数**、**哈希函数**都属于这类算法，其特点就是`单向性`、`无法反推原文`

数字证书需要向有权威的`认证机构(CA)`获取授权给服务器。首先，`服务器`和`CA`机构`分别有一对密钥`(公钥和私钥)，生成数字证书过程：

- CA机构通过摘要算法生成服务器公钥的`摘要`(哈希摘要)
- CA机构通过**CA私钥**及特定的签名算法**加密**摘要，生成`签名`
- 把`签名`、`服务器公钥`等信息打包`放入数字证书`，并返回给服务器




**证书验证流程**：

- 使用**CA公钥**和声明的签名算法对CA中的签名进行**解密**，得到服务器公钥的`摘要内容`
- 再用摘要算法对证书里的服务器公钥生成摘要，再把这个摘要和上一步得到的摘要`对比`，如果一致说明证书合法，里面的公钥也是正确的，否则就是非法的

**HTTPS连接过程**

**RSA握手**

早期的TLS通信使用的是RSA算法：

1. 浏览器给服务器发送一个随机数`client-random`和一个支持的加密方法列表
2. 服务器把另一个随机数`server-random`、`加密方法`、`公钥`传给浏览器
3. 浏览器又生成另一个随机数`pre-random`，并用公钥加密后传给服务器
4. 服务器再用私钥解密，得到`pre-random`，此时浏览器和服务器都得到三个随机数了，各自将三个随机数用加密方法混合生成最终密钥

缺点：由于数据通信过程中还是能被监听，故根据发送的信息有可能泄漏私钥。

**TLS 1.2版本**

采用了**ECDHE密钥交换法**：![61da6812fd7f4c3fb4ccf314165ffda5_tplv-k3u1fbpfcp-watermark](https://isbut-blog.oss-cn-shenzhen.aliyuncs.com/markdown-img/61da6812fd7f4c3fb4ccf314165ffda5_tplv-k3u1fbpfcp-watermark.png)



1. 浏览器给服务器发送一个随机数`client-random`、TLS版本和一个支持的加密方法列表
2. 服务器生成一个椭圆曲线参数`server-params`、随机数`server-random`、`加密方法`、`证书`等传给浏览器
3. 浏览器又生成椭圆曲线参数`client-params`，握手数据摘要等信息传给服务器
4. 服务器再返回摘要给浏览器确认应答

不再生成第三个随机数，由server-params`和`client-params`用ECDHE算法直接算出`pre-random，之后加密混合生成最终密钥。

**TLS 1.3版本**

![483eb3240c8f4986bdda4902650f7c41~tplv-k3u1fbpfcp-watermark](https://isbut-blog.oss-cn-shenzhen.aliyuncs.com/markdown-img/483eb3240c8f4986bdda4902650f7c41~tplv-k3u1fbpfcp-watermark.png)

1. 浏览器生成`client-params`、和`client-random`、TLS版本和加密方法列表发送给服务器
2. 服务器返回`server-params`、`server-random`、`加密方法`、`证书`、`摘要`等传给浏览器
3. 浏览器确认应答，返回握手数据摘要等信息传给服务器

由于params两个数经过特殊算法加密并且具有某种关联关系，攻击者知道只知道两个数值，无法破解。具体可以去了解ECDHE算法。

优点：将原来2-RTT优化成1-RTT。

**会话复用**

**Session ID**：客户端和服务器各自保存会话ID，进行复用，缺点：服务端存储压力大

**Session Ticket**：服务器加密会话信息以**Session Ticket**返回给客户端，验证消息没过期后，复用会话，将存储压力给了客户端。

做到0-RTT的方法：Session Ticket的时候带上应用数据，不用等服务端确认，这种方式被称为**`PSK`(Pre-Shared Key)**。



## WEB安全

**XSS攻击**

跨站脚本攻击，是利用HTML可执行`<script>alert(1)</script>`的特性，想尽办法将脚本注入页面中的攻击手段。XSS攻击有两种，一种是通过修改浏览器URL导致脚本被注入到页面，另一种是通过输入框将脚本代码注入数据库。

**CSRF攻击**

跨站请求伪造，源于Web的隐式身份验证机制，Web的身份验证机制虽然可以保证一个请求是来自于某个用户的浏览器，但却无法保证该请求是用户批准发送的。CSRF攻击的问题一般是由服务端解决，防范 CSRF 攻击可以遵循以下几种规则：

- Get 请求不用于对数据进行修改
- Cookie设置`HTTP Only`
- 接口设置禁止跨域
- 请求时附带验证信息，比如验证码或者 Token

**点击劫持**

点击劫持是一种视觉欺骗的攻击手段。攻击者将需要攻击的网站通过 iframe 嵌入自己的网页中，然后诱使用户点击。

使用一个HTTP响应头——`X-Frame-Options`。`X-Frame-Options`可以说是为了解决点击劫持而生的，它有三个可选的值：

1. DENY：浏览器会拒绝当前页面加载任何frame页面；
2. SAME-ORIGIN：iframe页面的地址只能为同源域名下的页面；
3. ALLOW-FROM origin：允许frame加载的页面地址；



**中间人攻击**

中间人攻击是攻击方同时与服务端和客户端建立起了连接，并让对方认为连接是安全的，但是实际上整个通信过程都被攻击者控制了。攻击者不仅能获得双方的通信信息，还能修改通信信息。中间人攻击的本质是客户端和服务端之间的认证和信任问题。

![d85e0644b4244675a9f707961cde1ed6~tplv-k3u1fbpfcp-watermark](https://isbut-blog.oss-cn-shenzhen.aliyuncs.com/markdown-img/d85e0644b4244675a9f707961cde1ed6~tplv-k3u1fbpfcp-watermark.png)

对称加密、非对称加密、混合加密技术都没有有效防止中间人攻击，因为中间人可以截取首次传输的密钥并偷天换日，而客户端或服务端并无法得知。HTTPS作为防止中间人攻击的终极手段，引入证书机制解决了客户端和服务端的信任问题，从而较为有效的防止了中间人攻击。
